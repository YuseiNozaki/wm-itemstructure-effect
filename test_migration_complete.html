<!DOCTYPE html>
<html>
<head>
  <title>Main jsPsych v8 Functionality Test</title>
  <script src="https://unpkg.com/jspsych@8.2.1/dist/jspsych.js"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0/dist/index.browser.min.js"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0/dist/index.browser.min.js"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@2.0.0/dist/index.browser.min.js"></script>
  <link href="https://unpkg.com/jspsych@8.2.1/css/jspsych.css" rel="stylesheet" type="text/css" />
</head>
<body>
  <div id="jspsych-target"></div>
  <script>
    // Test the same initialization pattern as main index.html
    const jsPsych = initJsPsych({
      display_element: 'jspsych-target',
      on_finish: function() {
        console.log('Test completed successfully');
        jsPsych.data.displayData();
      }
    });

    // Test all the key components used in the main experiment
    
    // 1. Welcome screen (html-keyboard-response)
    const welcome = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<h1>jsPsych v8 Migration Test</h1><p>Press Enter to continue.</p>',
      choices: ['Enter']
    };

    // 2. Demographics (survey-text)
    const demographics = {
      type: jsPsychSurveyText,
      questions: [
        {
          prompt: 'Age:',
          name: 'age',
          required: true
        }
      ],
      button_label: 'Next'
    };

    // 3. Gender selection (survey-multi-choice)
    const genderSelection = {
      type: jsPsychSurveyMultiChoice,
      questions: [
        {
          prompt: 'Gender:',
          name: 'gender',
          options: ['Male', 'Female', 'Other'],
          required: true
        }
      ],
      button_label: 'Next'
    };

    // 4. Test timeline variables
    const timelineVariableTest = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        const condition = jsPsych.timelineVariable('condition');
        return `<p>Condition: ${condition}</p><p>Press any key to continue.</p>`;
      }
    };

    // 5. Test randomization functions
    const randomizationTest = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        const colors = ['red', 'blue', 'green'];
        const randomColor = jsPsych.randomization.sampleWithoutReplacement(colors, 1)[0];
        return `<p>Random color selected: ${randomColor}</p><p>Press any key to continue.</p>`;
      }
    };

    // 6. Test data access
    const dataAccessTest = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        const lastData = jsPsych.data.get().last(1).values()[0];
        return `<p>Data access working. Last RT: ${lastData.rt || 'N/A'}</p><p>Press any key to continue.</p>`;
      }
    };

    // 7. Test factorial design
    const factorialTest = {
      timeline: [timelineVariableTest],
      timeline_variables: jsPsych.randomization.factorial({
        condition: ['A', 'B'],
        trial: [1, 2]
      }),
      randomize_order: true
    };

    // 8. Test 'NO_KEYS' and trial duration
    const noKeysTest = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<p>This will automatically continue after 2 seconds...</p>',
      choices: 'NO_KEYS',
      trial_duration: 2000
    };

    // Final screen
    const endScreen = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<h1>All Tests Passed!</h1><p>jsPsych v8 migration successful.</p>',
      choices: 'NO_KEYS',
      trial_duration: 3000
    };

    // Main timeline
    const timeline = [
      welcome,
      demographics,
      genderSelection,
      randomizationTest,
      factorialTest,
      dataAccessTest,
      noKeysTest,
      endScreen
    ];

    // Run the experiment
    jsPsych.run(timeline);
  </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
  <title>Test Window Drag Offset Fix</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #test-container { 
      position: relative; 
      width: 600px; 
      height: 400px; 
      border: 1px solid #ccc; 
      margin: 20px 0;
    }
    #test-window {
      position: absolute;
      left: 100px;
      top: 100px;
      width: 200px;
      height: 150px;
      border: 2px solid black;
      background-color: rgba(0, 100, 255, 0.3);
      cursor: move;
    }
    #results { margin: 20px 0; padding: 10px; background: #f0f0f0; }
    .pass { color: green; font-weight: bold; }
    .fail { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Test: Window Drag Offset Fix</h1>
  <p>This test validates that the window does not jump when dragging starts.</p>
  
  <div id="test-container">
    <div id="test-window">Drag me!</div>
  </div>
  
  <button onclick="runTest()">Run Test</button>
  <div id="results"></div>

  <script>
    let isMouseDown = false;
    let dragOffsetX = 0;
    let dragOffsetY = 0;
    
    const testWindow = document.getElementById('test-window');
    const testContainer = document.getElementById('test-container');
    
    // Fixed implementation
    function startDrag(e) {
      const windowRect = testWindow.getBoundingClientRect();
      const containerRect = testContainer.getBoundingClientRect();
      
      const clickX = e.clientX - containerRect.left;
      const clickY = e.clientY - containerRect.top;
      
      // Only start drag if clicking within the window
      if (clickX >= parseInt(testWindow.style.left) && 
          clickX <= parseInt(testWindow.style.left) + 200 &&
          clickY >= parseInt(testWindow.style.top) && 
          clickY <= parseInt(testWindow.style.top) + 150) {
        
        isMouseDown = true;
        
        // Calculate offset between cursor and window position
        dragOffsetX = clickX - parseInt(testWindow.style.left);
        dragOffsetY = clickY - parseInt(testWindow.style.top);
        
        log('‚úÖ FIXED: Started drag with offset (' + dragOffsetX + ', ' + dragOffsetY + ')');
      }
    }
    
    function dragWindow(e) {
      if (!isMouseDown) return;
      
      const containerRect = testContainer.getBoundingClientRect();
      const mouseX = e.clientX - containerRect.left;
      const mouseY = e.clientY - containerRect.top;
      
      // Move window using the stored offset
      let windowX = mouseX - dragOffsetX;
      let windowY = mouseY - dragOffsetY;
      
      // Keep window within container bounds
      windowX = Math.max(0, Math.min(windowX, 600 - 200));
      windowY = Math.max(0, Math.min(windowY, 400 - 150));
      
      testWindow.style.left = windowX + 'px';
      testWindow.style.top = windowY + 'px';
      
      log('‚úÖ FIXED: Window moved to (' + windowX + ', ' + windowY + ') maintaining offset');
    }
    
    function endDrag() {
      if (isMouseDown) {
        isMouseDown = false;
        log('‚úÖ FIXED: Drag ended');
      }
    }
    
    function log(message) {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
    }
    
    function runTest() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '<h3>Test Results:</h3>';
      
      // Reset window position
      testWindow.style.left = '100px';
      testWindow.style.top = '100px';
      
      log('üß™ Testing window drag with offset preservation...');
      
      // Test 1: Simulate click at center of window
      log('Test 1: Click at window center');
      const centerX = 100 + 100; // window left + half width
      const centerY = 100 + 75;  // window top + half height
      
      startDrag({clientX: centerX, clientY: centerY});
      const expectedOffsetX = 100; // Should be half window width
      const expectedOffsetY = 75;  // Should be half window height
      
      const passed1 = dragOffsetX === expectedOffsetX && dragOffsetY === expectedOffsetY;
      log(passed1 ? '‚úÖ PASS: Offset calculated correctly (' + dragOffsetX + ', ' + dragOffsetY + ')' : 
                   '‚ùå FAIL: Wrong offset (' + dragOffsetX + ', ' + dragOffsetY + ') expected (' + expectedOffsetX + ', ' + expectedOffsetY + ')', passed1);
      
      // Test 2: Simulate drag movement
      log('Test 2: Drag window to new position');
      const initialLeft = parseInt(testWindow.style.left);
      const initialTop = parseInt(testWindow.style.top);
      
      // Move 50px right and 30px down
      dragWindow({clientX: centerX + 50, clientY: centerY + 30});
      
      const finalLeft = parseInt(testWindow.style.left);
      const finalTop = parseInt(testWindow.style.top);
      
      const expectedLeft = initialLeft + 50;
      const expectedTop = initialTop + 30;
      
      const passed2 = finalLeft === expectedLeft && finalTop === expectedTop;
      log(passed2 ? '‚úÖ PASS: Window moved correctly to (' + finalLeft + ', ' + finalTop + ')' : 
                   '‚ùå FAIL: Window at (' + finalLeft + ', ' + finalTop + ') expected (' + expectedLeft + ', ' + expectedTop + ')', passed2);
      
      endDrag();
      
      log('Test completed. ' + (passed1 && passed2 ? 'All tests PASSED!' : 'Some tests FAILED.'));
    }
    
    // Set up event listeners
    testContainer.addEventListener('mousedown', startDrag);
    document.addEventListener('mousemove', dragWindow);
    document.addEventListener('mouseup', endDrag);
  </script>
</body>
</html>
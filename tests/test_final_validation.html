<!DOCTYPE html>
<html>
<head>
  <title>Final Validation Test - Variable Fixes</title>
  <meta charset="utf-8">
  <style>
    body { margin: 20px; font-family: Arial, sans-serif; }
    .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
    .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
    .info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
    pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; font-size: 12px; }
  </style>
</head>
<body>
  <h1>Final Validation Test</h1>
  <p>This test validates that both the <code>wm_load</code> and <code>practice_trial</code> variable issues have been fixed.</p>

  <div class="test-section info">
    <h3>Expected Behavior After Fix:</h3>
    <ul>
      <li><strong>practice_trial:</strong> TRUE for practice trials, FALSE for main experiment trials (no more placeholder objects)</li>
      <li><strong>wm_load:</strong> TRUE when memoryLoad = 'with-memory', FALSE when memoryLoad = 'without-memory'</li>
      <li><strong>Counterbalancing:</strong> Memory-first groups see memory trials first, memory-second groups see memory trials second</li>
    </ul>
  </div>

  <div class="test-section">
    <h3>Test Results:</h3>
    <button onclick="runComprehensiveTest()">Run Comprehensive Test</button>
    <div id="test-results"></div>
  </div>

  <script>
    function runComprehensiveTest() {
      const resultsDiv = document.getElementById('test-results');
      let html = '<h4>Timeline Variable Structure Test:</h4>';
      let allPassed = true;

      // Test 1: Practice trial variables structure
      const practiceVariables = [
        { viewCondition: 'fullscreen', structure: 'structured', memoryLoad: 'with-memory', isPractice: true },
        { viewCondition: 'window', structure: 'structured', memoryLoad: 'without-memory', isPractice: true }
      ];

      const practiceHasAllProps = practiceVariables.every(trial => 
        trial.hasOwnProperty('isPractice') && 
        trial.hasOwnProperty('memoryLoad') &&
        trial.isPractice === true
      );

      if (practiceHasAllProps) {
        html += '<p style="color: green;">✓ PASS: Practice variables have all required properties</p>';
      } else {
        html += '<p style="color: red;">✗ FAIL: Practice variables missing properties</p>';
        allPassed = false;
      }

      // Test 2: Main trial variables structure (with the fix)
      const mainVariables = [
        { viewCondition: 'fullscreen', structure: 'structured', memoryLoad: 'with-memory', isPractice: false },
        { viewCondition: 'window', structure: 'structured', memoryLoad: 'without-memory', isPractice: false }
      ];

      const mainHasAllProps = mainVariables.every(trial => 
        trial.hasOwnProperty('isPractice') && 
        trial.hasOwnProperty('memoryLoad') &&
        trial.isPractice === false
      );

      if (mainHasAllProps) {
        html += '<p style="color: green;">✓ PASS: Main variables have isPractice: false (fixes placeholder issue)</p>';
      } else {
        html += '<p style="color: red;">✗ FAIL: Main variables missing isPractice property</p>';
        allPassed = false;
      }

      // Test 3: wm_load logic validation
      const wmLoadTests = [
        { memoryLoad: 'with-memory', expectedWmLoad: true },
        { memoryLoad: 'without-memory', expectedWmLoad: false }
      ];

      let wmLoadTestPassed = true;
      wmLoadTests.forEach(test => {
        const result = test.memoryLoad === 'with-memory';
        if (result !== test.expectedWmLoad) {
          wmLoadTestPassed = false;
        }
      });

      if (wmLoadTestPassed) {
        html += '<p style="color: green;">✓ PASS: wm_load logic works correctly</p>';
      } else {
        html += '<p style="color: red;">✗ FAIL: wm_load logic incorrect</p>';
        allPassed = false;
      }

      // Test 4: Counterbalancing scenarios
      html += '<h4>Counterbalancing Test:</h4>';

      // Memory-first scenario (CONDITION = 1)
      const memoryFirstScenario = {
        condition: 1,
        memoryFirstCondition: true,
        practiceMemoryLoad: 'with-memory',
        firstBlockMemoryLoad: 'with-memory',
        secondBlockMemoryLoad: 'without-memory'
      };

      html += '<p><strong>Memory-First Group (CONDITION = 1):</strong></p>';
      html += `<p>Practice trials: memoryLoad = '${memoryFirstScenario.practiceMemoryLoad}' → wm_load = true</p>`;
      html += `<p>First 60 trials: memoryLoad = '${memoryFirstScenario.firstBlockMemoryLoad}' → wm_load = true</p>`;
      html += `<p>Second 60 trials: memoryLoad = '${memoryFirstScenario.secondBlockMemoryLoad}' → wm_load = false</p>`;

      // Memory-second scenario (CONDITION = 0)
      const memorySecondScenario = {
        condition: 0,
        memoryFirstCondition: false,
        practiceMemoryLoad: 'without-memory',
        firstBlockMemoryLoad: 'without-memory',
        secondBlockMemoryLoad: 'with-memory'
      };

      html += '<p><strong>Memory-Second Group (CONDITION = 0):</strong></p>';
      html += `<p>Practice trials: memoryLoad = '${memorySecondScenario.practiceMemoryLoad}' → wm_load = false</p>`;
      html += `<p>First 60 trials: memoryLoad = '${memorySecondScenario.firstBlockMemoryLoad}' → wm_load = false</p>`;
      html += `<p>Second 60 trials: memoryLoad = '${memorySecondScenario.secondBlockMemoryLoad}' → wm_load = true</p>`;

      // Test 5: Show the exact fix applied
      html += '<h4>Technical Fix Applied:</h4>';
      html += '<div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">';
      html += '<h5>1. practice_trial Variable Fix:</h5>';
      html += '<pre>// BEFORE: Main experiment trials had no isPractice property\n';
      html += 'withoutMemoryDesign.forEach(trial => {\n';
      html += '  trial.memoryLoad = "without-memory";\n';
      html += '  // Missing: trial.isPractice = false;\n';
      html += '});\n\n';
      html += '// AFTER: Explicitly set isPractice: false\n';
      html += 'withoutMemoryDesign.forEach(trial => {\n';
      html += '  trial.memoryLoad = "without-memory";\n';
      html += '  trial.isPractice = false;  // ✅ FIXED\n';
      html += '});</pre>';

      html += '<h5>2. wm_load Variable Fix:</h5>';
      html += '<pre>// BEFORE: Timeline variables accessed in event handler\n';
      html += 'const memoryLoadCondition = jsPsych.timelineVariable("memoryLoad");\n';
      html += 'const isPracticeCondition = jsPsych.timelineVariable("isPractice") || false;\n\n';
      html += '// AFTER: Variables captured early in on_load function\n';
      html += 'on_load: function() {\n';
      html += '  const memoryLoad = jsPsych.timelineVariable("memoryLoad");  // ✅ CAPTURED EARLY\n';
      html += '  const isPractice = jsPsych.timelineVariable("isPractice") || false;\n';
      html += '  // ... later in event handler ...\n';
      html += '  const memoryLoadCondition = memoryLoad;  // ✅ USE CAPTURED VALUE\n';
      html += '}</pre>';
      html += '</div>';

      // Final summary
      if (allPassed) {
        html += '<div class="test-section success">';
        html += '<h4>✅ All Tests Passed!</h4>';
        html += '<p>Both variable issues should now be resolved:</p>';
        html += '<ul>';
        html += '<li>practice_trial will show proper boolean values (true/false)</li>';
        html += '<li>wm_load will show correct values based on memory load condition</li>';
        html += '</ul>';
        html += '</div>';
      } else {
        html += '<div class="test-section error">';
        html += '<h4>❌ Some Tests Failed</h4>';
        html += '<p>Please review the failed tests above.</p>';
        html += '</div>';
      }

      resultsDiv.innerHTML = html;
    }
  </script>
</body>
</html>